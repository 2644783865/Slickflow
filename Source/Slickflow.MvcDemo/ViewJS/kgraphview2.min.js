var plumbUtility;plumbUtility||(plumbUtility={}),function(){plumbUtility.importDefault=function(){jsPlumb.importDefaults({DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"},{fillStyle:"#558822"}],Endpoints:[["Dot",{radius:2}],["Dot",{radius:2}]],ConnectionOverlays:[["Arrow",{location:1,width:10,length:10,foldback:1}],["Label",{location:.1,id:"label",cssClass:"aLabel"}]]})};var e={lineWidth:.6,strokeStyle:"#096EBB",joinstyle:"round",outlineColor:"#096EBB",outlineWidth:.6},t={lineWidth:1,strokeStyle:"#5C96BC",outlineWidth:1,outlineColor:"white"},n={fillStyle:"#5C96BC"};plumbUtility.drawUtil={sourceEndpoint:{endpoint:"Dot",paintStyle:{strokeStyle:"#1e8151",fillStyle:"transparent",radius:3,lineWidth:1},isSource:!0,maxConnections:-1,connector:["Flowchart",{stub:[6,6],gap:1,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:e,hoverPaintStyle:n,connectorHoverStyle:t,dragOptions:{},overlays:[["Label",{location:[.5,1.5],label:"",cssClass:"endpointSourceLabel"}]]},targetEndpoint:{endpoint:"Dot",paintStyle:{fillStyle:"#1e8151",radius:3},hoverPaintStyle:n,maxConnections:-1,dropOptions:{hoverClass:"hover",activeClass:"active"},isTarget:!0,overlays:[["Label",{location:[.5,-.5],label:"",cssClass:"endpointTargetLabel"}]]},addEndpoints:function(e,t,n){for(var i=0;i<t.length;i++){var r=e+t[i];jsPlumb.addEndpoint(e,this.sourceEndpoint,{anchor:t[i],uuid:r})}for(var o=0;o<n.length;o++){var a=e+n[o];jsPlumb.addEndpoint(e,this.targetEndpoint,{anchor:n[o],uuid:a})}}}}();var kloader;kloader||(kloader={}),function(){kloader.createNew=function(e){var t={},n={},i=[{id:jshelper.getUUID(),name:"开始",code:"start",type:"StartNode",left:370,top:70,width:50,height:50,inputConnectors:[{type:"input",index:1,name:"A"}],outputConnectors:[{type:"output",index:1,name:"X"}]},{id:jshelper.getUUID(),name:"结束",code:"end",type:"EndNode",left:370,top:370,width:50,height:50,inputConnectors:[{type:"input",index:1,name:"A"}],outputConnectors:[{type:"output",index:1,name:"X"}]}];t.process=n,n.id=e.ProcessGUID,n.name=e.ProcessName,n.description=e.Description,n.snodes=i;var r=new kgraph.GraphView(e.ProcessGUID,t);return r},kloader.initialize=function(e){var t={},n={},i=[],r=$.parseXML(e.XmlContent);t.participants=i,t.process=n,$(r).find("Participant").each(function(e){var t={};t.type=$(this).attr("type"),t.id=$(this).attr("id"),t.name=$(this).attr("name"),t.code=$(this).attr("code"),t.outerId=$(this).attr("outerId"),i.push(t)});var o=$(r).find("Process");if(o){var a=[],s=[];n.name=$(o).attr("name"),n.id=$(o).attr("id");var l=$(o).children("Description");n.description=jshelper.replaceHTMLTags($(l).text()),n.snodes=a,n.slines=s,$(o).find("Activity").each(function(e){var t=this,n={},i={},r=[],o={},s={},l={};n.id=$(t).attr("id"),n.name=$(t).attr("name"),n.code=$(t).attr("code"),n.text="";var d=$(t).find("Description");n.description=jshelper.replaceHTMLTags($(d).text()),i=$(t).find("ActivityType"),n.type=$(i).attr("type"),"GatewayNode"==n.type?(n.gatewaySplitJoinType=$(i).attr("gatewaySplitJoinType"),n.gatewayDirection=$(i).attr("gatewayDirection")):"SubProcessNode"==n.type?n.subId=$(i).attr("subId"):"MultipleInstanceNode"==n.type&&(n.complexType=$(i).attr("complexType"),n.mergeType=$(i).attr("mergeType"),n.compareType=$(i).attr("compareType"),n.completeOrder=$(i).attr("completeOrder")),$(t).find("Performer").each(function(e){var t=this,n={};n.id=$(t).attr("id"),r.push(n)}),n.performers=r,o=$(t).find("Geography"),s=$(o).find("Widget");var c=[],p=[];n.inputConnectors=c,n.outputConnectors=p,n.left=parseInt($(s).attr("left")),n.top=parseInt($(s).attr("top")),n.width=parseInt($(s).attr("width")),n.height=parseInt($(s).attr("height")),l=$(s).find("Connectors"),$(l).find("Connector").each(function(e){var t=this,i={};i.type=$(t).attr("type"),i.index=$(t).attr("index"),i.name=$(t).attr("name");var r=$(t).attr("type");"input"==r?n.inputConnectors.push(i):"output"==r&&n.outputConnectors.push(i)}),a.push(n)}),$(r).find("Transition").each(function(e){var t={};t.id=$(this).attr("id"),t.from=$(this).attr("from"),t.to=$(this).attr("to");var n=$(this).find("Description");t.description=jshelper.replaceHTMLTags($(n).text());var i={},r=$(this).find("Condition"),o=$(r).attr("type");if(void 0!==o){i.type=o;$(this).find("ConditionText");i.text=jshelper.replaceHTMLTags($(r).text())}t.condition=i;var a=$(this).find("Geography"),l=$(a).find("Line");t.fromConnector=$(l).attr("fromConnector"),t.toConnector=$(l).attr("toConnector"),s.push(t)})}var d={processGUID:e.ProcessGUID,version:e.Version,packageData:t},c=new kgraph.GraphView(d);return c},kloader.serialize2Xml=function(e,t){var n={},i=new XMLWriter("utf-8","1.0");i.formatting="indented",i.indentChar=" ",i.indentation=2,i.writeStartDocument(void 0),i.writeStartElement("Package");var r=t.participants;if(r){var o=r.length;if(o>0){i.writeStartElement("Participants");for(var a=0;o>a;a++){var s=r[a];i.writeStartElement("Participant"),i.writeAttributeString("type",s.type),i.writeAttributeString("id",s.id),i.writeAttributeString("name",s.name),i.writeAttributeString("code",s.code),i.writeAttributeString("outerId",s.outerId),i.writeEndElement()}i.writeEndElement()}}var l=t.process;i.writeStartElement("WorkflowProcesses"),i.writeStartElement("Process"),i.writeAttributeString("name",l.name),i.writeAttributeString("id",l.id),l.description&&i.writeElementString("Description",jshelper.escapeHtml(l.description));var d=l.snodes.length;if(d>0){i.writeStartElement("Activities");for(var c=0;d>c;c++){var p=l.snodes[c];if(i.writeStartElement("Activity"),i.writeAttributeString("name",p.name),i.writeAttributeString("id",p.id),i.writeAttributeString("code",p.code),p.description&&i.writeElementString("Description",jshelper.escapeHtml(p.description)),i.writeStartElement("ActivityType"),i.writeAttributeString("type",p.type),"GatewayNode"==p.type?(i.writeAttributeString("gatewaySplitJoinType",p.gatewaySplitJoinType),i.writeAttributeString("gatewayDirection",p.gatewayDirection)):"SubProcessNode"==p.type?i.writeAttributeString("subId",p.subId):"MultipleInstanceNode"==p.type&&(i.writeAttributeString("complexType",p.complexType),i.writeAttributeString("mergeType",p.mergeType),i.writeAttributeString("compareType",p.compareType),i.writeAttributeString("completeOrder",p.completeOrder)),i.writeEndElement(),p.performers){var u=p.performers.length;if(u>0){i.writeStartElement("Performers");for(var m=0;u>m;m++){var h=p.performers[m];i.writeStartElement("Performer"),i.writeAttributeString("id",h.id),i.writeEndElement()}i.writeEndElement()}}i.writeStartElement("Geography"),i.writeStartElement("Widget"),i.writeAttributeString("left",p.left),i.writeAttributeString("top",p.top),i.writeAttributeString("width",p.width),i.writeAttributeString("height",p.height);var g=p.inputConnectors.length,f=p.outputConnectors.length;if(g>0||f>0){if(i.writeStartElement("Connectors"),g>0)for(var E=0;g>E;E++){var v=p.inputConnectors[E];i.writeStartElement("Connector"),i.writeAttributeString("type",v.type),i.writeAttributeString("index",v.index),i.writeAttributeString("name",v.name),i.writeEndElement()}if(f>0)for(var y=0;f>y;y++){var v=p.outputConnectors[y];i.writeStartElement("Connector"),i.writeAttributeString("type",v.type),i.writeAttributeString("index",v.index),i.writeAttributeString("name",v.name),i.writeEndElement()}i.writeEndElement()}i.writeEndElement(),i.writeEndElement(),i.writeEndElement()}i.writeEndElement()}if(l.slines){var w=l.slines.length;if(w>0){i.writeStartElement("Transitions");for(var k=0;w>k;k++){var S=l.slines[k];i.writeStartElement("Transition"),i.writeAttributeString("id",S.id),i.writeAttributeString("from",S.from),i.writeAttributeString("to",S.to),S.description&&i.writeElementString("Description",jshelper.escapeHtml(S.description)),S.condition&&(i.writeStartElement("Condition"),S.condition.type&&(i.writeAttributeString("type",S.condition.type),S.condition.text&&(i.writeStartElement("ConditionText"),i.writeCDATA(S.condition.text),i.writeEndElement())),i.writeEndElement()),i.writeStartElement("Geography"),i.writeStartElement("Line"),i.writeAttributeString("fromConnector",S.fromConnector),i.writeAttributeString("toConnector",S.fromConnector),i.writeEndElement(),i.writeEndElement(),i.writeEndElement()}i.writeEndElement()}}return i.writeEndElement(),i.writeEndElement(),i.writeEndElement(),i.writeEndDocument(),n.ProcessGUID=e,n.XmlContent=i.flush(),i.close(),n}}();var kgraph;kgraph||(kgraph={}),function(){kgraph.Config={NODE_PREFIX:"ACT",NODE_TYPE_START:"StartNode",NODE_TYPE_TASK:"TaskNode",NODE_TYPE_END:"EndNode",NODE_TYPE_GATEWAY:"GatewayNode",NODE_TYPE_SUBPROCESS:"SubProcessNode",NODE_TYPE_MULTIPLEINSTANCE:"MultipleInstanceNode",NODE_TYPE_COMPLEX_SIGNTOGETHER:"SignTogether",NODE_TYPE_COMPLEX_SIGHFORWARD:"SignForward",ELEMENT_TYPE_NODE:"NODE",ELEMENT_TYPE_CONNECTION:"CONNECTION"},kgraph.GraphView=function(e){var t=this;this.processGUID=e.processGUID,this.packageData=e.packageData,this.processData=e.packageData.process;var n=function(){plumbUtility.importDefault(),jsPlumb.setContainer("kgraphContainer"),jsPlumb.bind("connection",function(n,a){var s=n.source.id.substr(3,n.source.id.length-3),l=n.target.id.substr(3,n.target.id.length-3),d=r(s,l);if(null===d){d={id:jshelper.getUUID(),from:s,to:l,description:"请输入转移描述信息",fromConnector:1,toConnector:1};var c=e.packageData.process.slines;c.push(d);var p=new kgraph.Line(d);t.lines.push(p)}n.connection.bind("click",function(e,t){var r=n.source.id.substr(3,n.source.id.length-3),a=n.target.id.substr(3,n.target.id.length-3),s=o(r,a);i(e,s)}).bind("dblclick",function(e,t){kmain.mdialogOpened=!0;var n=$("#divTransitionDialog").load("/sfd/views/transitionproperty.html",function(){var e={title:"转移定义数据",width:500,height:400,modal:!0,autoOpen:!1,beforeClose:function(e,t){},close:function(e,t){kmain.mdialogOpened=!1}},t=kmain.currentSelectedDomElement.line;n.data("line",t).dialog(e).dialog("open"),n.parent(".ui-dialog").css("zIndex",9999)})})}),jsPlumb.registerConnectionTypes({selected:{paintStyle:{strokeStyle:"red",lineWidth:1},hoverPaintStyle:{lineWidth:1.5},cssClass:"connector-selected"}}),jsPlumb.draggable("item_left",{grid:[10,10]})},i=function(e,t){null!=kmain.currentSelectedDomElement&&(null!=kmain.currentSelectedDomElement.connection?kmain.currentSelectedDomElement.connection.toggleType("selected"):null!=kmain.currentSelectedDomElement.node&&$(kmain.currentSelectedDomElement.element).toggleClass("highlight")),kmain.currentSelectedDomElement={type:kgraph.Config.ELEMENT_TYPE_CONNECTION,connection:e,line:t},e.toggleType("selected")},r=function(t,n){for(var i=null,r=e.packageData.process.slines,o=0;o<r.length;o++)if(r[o].from===t&&r[o].to===n){i=r[o];break}return i},o=function(e,n){for(var i=null,o=r(e,n),a=0;a<t.lines.length;a++)if(o.id==t.lines[a].id()){i=t.lines[a];break}return i};n();var a=function(e){var t=null,n=[];if(e)for(var i=0;i<e.length;i++)t=new kgraph.Node(e[i]),n.push(t);return n};this.nodes=a(this.processData.snodes);var s=function(t){for(var n=null,i=e.packageData.process.snodes,r=0;r<i.length;r++)if(i[r].id==t){n=i[r];break}return n},l=function(e){var t=null,n=[];if(e)for(var i=0;i<e.length;i++){var r=s(e[i].from),o=s(e[i].to);t=new kgraph.Line(e[i],r,o),t.render(),n.push(t)}return n};this.lines=l(this.processData.slines),this.drawSingleNode=function(e){var t={id:jshelper.getUUID(),code:"",type:e.type,complexType:e.complexType,left:e.left,top:e.top,inputConnectors:[],outputConnectors:[]};if(e.type==kgraph.Config.NODE_TYPE_START)t.name="开始";else if(e.type==kgraph.Config.NODE_TYPE_END)t.name="结束";else if(e.type==kgraph.Config.NODE_TYPE_GATEWAY)t.name="Gateway";else if(e.type==kgraph.Config.NODE_TYPE_SUBPROCESS)t.name="子流程";else if(e.type==kgraph.Config.NODE_TYPE_TASK)t.name="新节点";else{if(e.type!=kgraph.Config.NODE_TYPE_MULTIPLEINSTANCE)throw new Error("未知节点类型！");t.name="会(加)签"}var n=new kgraph.Node(t);this.processData.snodes.push(t),this.nodes.push(n)}},kgraph.Node=function(e){this.sdata=e;var t=this;this.id=function(){return this.sdata.id},this.name=function(){return this.sdata.name||""},this.code=function(){return this.sdata.code||""},this.text=function(){return this.sdata.text||""},this.type=function(){return this.sdata.type},this.complexType=function(){return this.sdata.complexType},this.left=function(){return this.sdata.left},this.top=function(){return this.sdata.top},this.width=function(){return this.sdata.width},this.height=function(){return this.sdata.height},this.setNodeName=function(e){var t=kgraph.Config.NODE_PREFIX+this.id();$("#"+t).text(e)},this.render=function(){var r=null,o=kgraph.Config.NODE_PREFIX+this.id();if(this.type()===kgraph.Config.NODE_TYPE_START)r=this.renderStartNode(o);else if(this.type()===kgraph.Config.NODE_TYPE_END)r=this.renderEndNode(o);else if(this.type()===kgraph.Config.NODE_TYPE_TASK||this.type()===kgraph.Config.NODE_TYPE_MULTIPLEINSTANCE)r=this.renderTaskNode(o,this);else if(this.type()===kgraph.Config.NODE_TYPE_GATEWAY)r=this.renderGatewayNode(o,this);else{if(this.type()!==kgraph.Config.NODE_TYPE_SUBPROCESS)throw new Error("未知节点类型！");r=this.renderSubProcessNode(o,this)}this.sdata.width=r.width(),this.sdata.height=r.height(),r.bind("click",function(){n(t,this)}).bind("dblclick",function(){i(t)}),jsPlumb.draggable(o,{grid:[10,10],stop:function(t,n){var i=n.position.left,r=n.position.top;e.left=Math.round(1e4*i)/1e4,e.top=Math.round(1e4*r)/1e4}})};var n=function(e,t){null!=kmain.currentSelectedDomElement&&(null!=kmain.currentSelectedDomElement.connection?kmain.currentSelectedDomElement.connection.toggleType("selected"):null!=kmain.currentSelectedDomElement.node&&$(kmain.currentSelectedDomElement.element).toggleClass("highlight")),kmain.currentSelectedDomElement={type:kgraph.Config.ELEMENT_TYPE_NODE,node:e,element:t},$(kmain.currentSelectedDomElement.element).toggleClass("highlight")};this.renderTaskNode=function(e,t){var n=$("<div>").attr("id",e).addClass("node");return n.css({left:this.sdata.left,top:this.sdata.top,position:"absolute"}),n.text(t.name()),$("#kgraphContainer").append(n),plumbUtility.drawUtil.addEndpoints(e,["Right","Bottom"],["Top","Left"]),n},this.renderGatewayNode=function(e,t){var n=$("<div>").attr("id",e).addClass("gateway");return n.css({left:this.sdata.left-10,top:this.sdata.top+10,position:"absolute"}),$("#kgraphContainer").append(n),plumbUtility.drawUtil.addEndpoints(e,["Right"],["Left"]),n},this.renderSubProcessNode=function(e,t){var n=$("<div>").attr("id",e).addClass("node");return n.css({left:this.sdata.left,top:this.sdata.top,position:"absolute"}),n.text(t.name()),$("#kgraphContainer").append(n),plumbUtility.drawUtil.addEndpoints(e,["Right"],["Left"]),n},this.renderStartNode=function(e){var t=$("<div>").attr("id",e).addClass("circle-start");return t.css({left:this.sdata.left,top:this.sdata.top,position:"absolute"}),$("#kgraphContainer").append(t),plumbUtility.drawUtil.addEndpoints(e,["Right"],[]),t},this.renderEndNode=function(e){var t=$("<div>").attr("id",e).addClass("circle-end");return t.css({left:this.sdata.left,top:this.sdata.top,position:"absolute"}),$("#kgraphContainer").append(t),plumbUtility.drawUtil.addEndpoints(e,[],["Left","Top"]),t},this.render();var i=function(e){kmain.mdialogOpened=!0,$("#divActivityDialog").children().remove();var t="",n="";if(e.type()==kgraph.Config.NODE_TYPE_TASK)t="活动节点属性",n="/sfd/views/activityproperty.html";else if(e.type()==kgraph.Config.NODE_TYPE_GATEWAY)t="Gateway节点属性",n="/sfd/views/gatewayproperty.html";else if(e.type()==kgraph.Config.NODE_TYPE_SUBPROCESS)t="子流程节点属性",n="/sfd/views/subprocessproperty.html";else{if(e.type()!=kgraph.Config.NODE_TYPE_MULTIPLEINSTANCE)return;t="会加签节点属性",n="/sfd/views/activityproperty.html"}var i={title:t,width:530,height:560,modal:!0,autoOpen:!1,opacity:.9,beforeClose:function(e,t){},close:function(e,t){kmain.mdialogOpened=!1,$(this).children().remove(),$(this).dialog("destroy")}},r=$("#divActivityDialog").load(n,function(){r.data("node",e).dialog(i).dialog("open"),r.parent(".ui-dialog").css("zIndex",9999)})}},kgraph.Line=function(e,t,n){this.sdata=e,this.connection=null;this.id=function(){return this.sdata.id},this.from=function(){return this.sdata.from},this.to=function(){return this.sdata.to},this.render=function(){var i="",r="";t.type==kgraph.Config.NODE_TYPE_GATEWAY?(i="Right",r=n.type==kgraph.Config.NODE_TYPE_TASK?"Top":"Left"):(i="Right",r="Left");var o=kgraph.Config.NODE_PREFIX+e.from,a=kgraph.Config.NODE_PREFIX+e.to,s=o+i,l=a+r,d=jsPlumb.connect({uuids:[s,l],editable:!1});this.connection=d}}}();var kmain;kmain||(kmain={}),function(){function e(e,t,n){$("#"+n).css({"-webkit-transform":"scale("+t+")","-moz-transform":"scale("+t+")","-ms-transform":"scale("+t+")","-o-transform":"scale("+t+")",transform:"scale("+t+")",TransformOrigin:"0% 0%"}),e.setZoom(t)}mopType=null,misSelectedNew=!1,mselectedProcessGUIDCurrent=null,mselectedProcessGUIDPrevious=null,mselectedProcessVersion=null,mgraphView=null,mcurrentPackageData=null,mdialogOpened=!1,selectedActivityPerformerGUID=null,selectedParticipantType=null,selectedParticipantItem=null,currentSelectedDomElement=null,currentSelectedLine=null,kmain.init=function(){$("#ulSuperMenu").superfish({});$("#kgraphContainer").empty(),n(),i(),t()};var t=function(){$(document).keyup(function(e){46!=e.keyCode||void 0!==kmain.mdialogOpened&&kmain.mdialogOpened!==!1||null!=kmain.currentSelectedDomElement&&(kmain.currentSelectedDomElement.type===kgraph.Config.ELEMENT_TYPE_NODE?$.msgBox({title:"Are You Sure",content:"确认要删除节点吗? 将会删除节点属性及用户角色等数据!!!",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(e){return"Yes"==e?(jsPlumb.remove(kmain.currentSelectedDomElement.element),o(kmain.currentSelectedDomElement.node),void(kmain.currentSelectedDomElement=null)):void 0}}):kmain.currentSelectedDomElement.type===kgraph.Config.ELEMENT_TYPE_CONNECTION&&$.msgBox({title:"Are You Sure",content:"确认要删除连线吗? 将会删除连线上的条件等数据!!!",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(e){return"Yes"==e?(jsPlumb.detach(kmain.currentSelectedDomElement.connection),a(kmain.currentSelectedDomElement.line),void(kmain.currentSelectedDomElement=null)):void 0}}))})},n=function(){$(".imagepart").draggable({helper:"clone",scope:"dragflag"})},i=function(){$("#kgraphContainer").droppable({accept:".imagepart",activeClass:"drop-active",scope:"dragflag",cursor:"cross",drop:function(e,t){var n=parseInt(t.offset.left-$(this).offset().left),i=parseInt(t.offset.top-$(this).offset().top)+4,r=t.draggable[0].id,o={type:r,left:n,top:i};return void 0===kmain.mgraphView?void $.msgBox({title:"Designer / Index",content:"请先打开流程记录！",type:"info"}):void kmain.mgraphView.drawSingleNode(o)}})};kmain.createProcess=function(){kmain.mopType="NEW",r()},kmain.loadProcess=function(){kmain.mopType="OPEN",r()};var r=function(){var e={title:"流程定义数据",width:700,height:500,modal:!0,autoOpen:!1,opacity:.9,beforeClose:function(e,t){kmain.setSelectedProcessGUIDCurrent(processManager.pselectedProcessGUID);var n=kmain.mselectedProcessGUIDCurrent,i=kmain.mselectedProcessVersion,r={processGUID:n,processVersion:i};kmain.misSelectedNew&&n&&processFileManager.queryProcessFile(r,function(e){if(1==e.Status){jsPlumb.deleteEveryEndpoint(),jsPlumb.detachEveryConnection(),jsPlumb.empty("kgraphContainer");var t=e.Entity;kmain.mgraphView=kloader.initialize(t),kmain.mcurrentPackageData=kmain.mgraphView.packageData}else $.msgBox({title:"Ooops",content:e.Message,type:"error",buttons:[{value:"Ok"}]})})},close:function(e,t){$(this).children().remove(),$(this).dialog("destroy")}},t=$("#divProcessDialog").load("/sfd/views/processlist.html",function(){t.dialog(e).dialog("open"),t.parent(".ui-dialog").css("zIndex",9999)})};kmain.setSelectedProcessGUIDCurrent=function(e){kmain.mselectedProcessGUIDCurrent!=e?(kmain.mselectedProcessGUIDPrevious=kmain.mselectedProcessGUIDCurrent,kmain.mselectedProcessGUIDCurrent=e,kmain.misSelectedNew=!0):kmain.misSelectedNew=!1},kmain.cancelProcessRecord=function(){kmain.misSelectedNew=!1},kmain.saveProcessFile=function(){if(void 0!==kmain.mgraphView){var e=kmain.mgraphView.processGUID,t=kmain.mgraphView.packageData,n=kloader.serialize2Xml(e,t);processFileManager.saveProcessFile(n)}else $.msgBox({title:"Designer / Index",content:"请确认图形是否处于编辑状态！",buttons:[{value:"Ok"}]})};var o=function(e){for(var t=e.id(),n=[],i=[],r=kmain.mgraphView.lines,o=kmain.mgraphView.processData.slines,a=0;a<r.length;a++)(t==r[a].from()||t==r[a].to())&&i.push(a);for(var a=i.length-1;a>=0;a--)r.splice(i[a],1);for(var a=0;a<o.length;a++)(t==o[a].from||t==o[a].to)&&n.push(a);for(var a=n.length-1;a>=0;a--)o.splice(n[a],1);for(var s=kmain.mgraphView.nodes,a=0;a<s.length;a++)if(t==s[a].id()){s.splice(a,1);break}for(var l=kmain.mgraphView.processData.snodes,a=0;a<l.length;a++)if(t==l[a].id){l.splice(a,1);break}},a=function(e){for(var t=e.id(),n=kmain.mgraphView.lines,i=kmain.mgraphView.processData.slines,r=0;r<n.length;r++)if(t==n[r].id()){n.splice(r,1);break}for(var r=0;r<i.length;r++)if(t==i[r].id){i.splice(r,1);break}};kmain.exportXML=function(){var e=kmain.mgraphView.processGUID,t=kmain.mgraphView.packageData,n=kloader.serialize2Xml(e,t);kmain.currentXmlContent=n.XmlContent;var i=$("#divXmlContentDialog").load("/sfd/views/xmlcontent.html",function(){var e={title:"流程定义XML内容",width:700,height:500,modal:!0,autoOpen:!1,beforeClose:function(e,t){kmain.currentXmlConent=""},close:function(e,t){$(this).children().remove(),$(this).dialog("destroy")}};i.dialog(e).dialog("open"),i.parent(".ui-dialog").css("zIndex",9999)})},kmain.exportPNG=function(){var e=$("#kgraphContainer").get(0);html2canvas(e,{onrendered:function(t){ctx=t.getContext("2d"),$flows=$("> svg",e),$flows.each(function(){$svg=$(this),offset=$svg.position(),svgStr=this.outerHTML,ctx.drawSvg(svgStr,offset.left-226,offset.top-58)}),$endpoints=$("._jsPlumb_endpoint > svg",e),$endpoints.each(function(){$svg=$(this),offset=$svg.parent().position(),svgStr=this.outerHTML,ctx.drawSvg(svgStr,offset.left,offset.top)}),t.toBlob(function(e){saveAs(e,"screenshot.png")})}})},kmain.ratioDisplay=function(){var t=document.getElementById("rear-ratio"),n=document.getElementById("rear-ratio-display");n.value=t.value,e(jsPlumb,t.value/100,"kgraphContainer"),$("#kgraphContainer").css({left:"0px",right:"180px"})},kmain.ratioDisplay2=function(){var t=document.getElementById("rear-ratio-display"),n=document.getElementById("rear-ratio");n.value=t.value,e(jsPlumb,t.value/100,"kgraphContainer"),$("#kgraphContainer").css({left:"0px",right:"180px"})}}();